---
title: "COVID-19 statistika"
output: distill::distill_article
---

```{r, echo=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
tt <- read_csv("data/lt-covid19-total.csv") 
```

```{r include = FALSE}
data <- Sys.time()
```

Atnaujinta: `r data`. 

# Suminiai atvejai

Sudėti dieniniai susirgimų atvejai, dieniniai pasveikusiųjų ir dieniniai mirusiųjų atvejai. Neatsižvelgiama į 2020-04-28 paskelbtą SAM korekciją.

```{r, echo = FALSE}
stt <- tt %>% select(day, confirmed, deaths, recovered) %>% pivot_longer(confirmed:recovered, "type")
ggplot(aes(x = day, y = value, group = type, colour = type), data =stt) + geom_point()+geom_line()+labs(title = paste("Cumulative cases:",max(tt$day))) + scale_color_manual(values = c("confirmed" = "red", "recovered" = "springgreen", deaths = "black"))
```

# Nauji atvejai

Dieniniai susirgimų atvejai, dieniniai pasveikusiųjų ir dieniniai mirusiųjų atvejai. Neatsižvelgiama į 2020-04-28 paskelbtą SAM korekciją, nes nebuvo paskelbta koreguota istorinė eilutė.

```{r, echo = FALSE}
ag <- function(x)c(x[1],diff(x))
ntt <- stt %>% arrange(type, day) %>% group_by(type) %>%  mutate(value = ag(value)) %>% ungroup
ggplot(aes(x = day, y = value, group = type), data =ntt) + geom_col(aes(fill=type),position = "dodge",)+labs(title = paste("New cases:",max(tt$day))) + scale_fill_manual(values = c("confirmed" = "red", "recovered" = "springgreen", deaths = "black"))
```


# Testų skaičius

Kas dieną atliktų testų suma. SAM kiekvieną dieną praneša suminį testų skaičių ir tą dieną atliktų testų skaičių. Sumuojant pastarąjį per visas dienas jis turėtų sutapti su skelbiamu testų skaičiumi. Taip ne visados įvykdavo, todėl čia skelbiamas tik suminis testų skaičius.

```{r, echo = FALSE}
ggplot(aes(x = day, y = tested), data = tt) +geom_point() + geom_line() + labs(title = paste("Cumulative tests:",max(tt$day)),  x = "tested")
```


# Per dieną atliktų testų skaičius


Nuo balandžio 1 d. pradėjus skelbti laboratorijų testų skaičius, dieninis skaičių testas imamas iš šių duomenų.

```{r, echo = FALSE}
library(lubridate)
labs <- read.csv("data/lt-covid19-laboratory-total.csv", stringsAsFactors = FALSE) %>% mutate(day = ymd(day))

lbt <- labs %>% group_by(day) %>% summarise(daily_tests = sum(tested_all))
ltt <- tt %>% mutate(daily_tests = ag(tested)) %>% select(day, daily_tests)

lct <- ltt %>% left_join(lbt %>% rename(laboratory_tests = daily_tests), by = "day") %>% 
    mutate(sam_daily_tests = daily_tests, 
           daily_tests = ifelse(is.na(laboratory_tests), sam_daily_tests, laboratory_tests)) 
    

ggplot(aes(x = day, y = daily_tests), data = lct) +geom_col() + labs(title = paste("Daily tests: ", max(tt$day)), y="tested")
```

# Atvejų skaičius tenkantis 100 testų

Pateikiama istorinė eilutė

```{r}
tpd <- tt %>% select(day, confirmed) %>% left_join(lct, by = "day") %>% 
    mutate(incidence = ag(confirmed), normalized = incidence*100/daily_tests, percent = incidence/daily_tests*100)
ggplot(aes(x = day, y = normalized), data = tpd) +geom_point() + geom_line() + labs(title = paste("Confirmed daily cases per 100 tests", max(tt$day)),  y = "")

```

Pateikiama eilutė nuo 2020-04-01

```{r}
tpd <- tt %>% select(day, confirmed) %>% left_join(lct, by = "day") %>% 
    mutate(incidence = ag(confirmed), normalized = incidence*100/daily_tests, percent = incidence/daily_tests*100)
ggplot(aes(x = day, y = normalized), data = tpd %>% filter(day>="2020-04-01")) +geom_point() + geom_line() + labs(title = paste("Confirmed daily cases per 100 tests since 2020-04-01", max(tt$day)),  y = "")

```

# Profilaktiniai testai

SAM vieną kartą paskelbė duomenis kiek testuojama profilaktiškai. Šitie duomenys nėra atnaujinami.

```{r}

pr <- read.csv("tests/profilactic.csv", stringsAsFactors = FALSE) %>% mutate(day = ymd(day))

ggplot(aes(x = day, y = profilactic), data = pr) +geom_point() + geom_line() + 
           labs(title = paste("Profilactic tests per day", max(tt$day)),  y = "")

```


Profilaktiniai testai daromi padidintos rizikos darbuotojams. Norint analizuoti naujus susirgimus ir epidemijos plitimą, juos reikėtų išimti iš bendros statistikos.

```{r}
prt <- tpd %>% inner_join(pr, by = "day") %>% mutate(profilactic_removed = 100*(incidence/(daily_tests-profilactic))) %>% 
    select(day, normalized, profilactic_removed ) %>% pivot_longer(normalized:profilactic_removed)

ggplot(aes(x= day, y=value, group = name, colour =name), data=prt)+geom_point()+geom_line() +labs(title = paste("Confirmed cases per 100 total tests vs 100 non-profilactic tests"))

```

# Laboratorijų duomenys

```{r, echo = FALSE, fig.height=10, fig.width=10}


labst <- labs %>% select(day, laboratory, tested_all, positive_all, not_tested) %>% pivot_longer(tested_all:not_tested, "type")


ggplot(aes(x = day, y = value, group = type), data = labst) + geom_col(aes(fill=type),position = "dodge")+ facet_wrap(~laboratory, scales = "free_y")+labs(title = paste("Laboratory tests:",max(labs$day)))
```

Laboratorijos pajėgumas tai istorinis laboratorijoje darytų testų maksimumas. Grafike vaizduojamas kiek kurią dieną laboratorijos išnaudoja savo pajėgumus procentais.


```{r}
labs <- labs %>% group_by(laboratory) %>% mutate(tested_all = ifelse(is.na(tested_all), 0, tested_all), capacity= 100*(tested_all/max(tested_all)))

ggplot(aes(x = day, y = capacity, group = laboratory) , data = labs) + geom_col(aes(fill=laboratory),position = "dodge")+ labs(title = paste("Laboratory capacity, percentage:",max(labs$day)))
```


Visų laboratorijų pajėgumai yra kiekvienos laboratorijos pajėgumų suma. Grafike vaizduojama kiek visos laboratorijos kartu išnaudoja savo pajėgumus procentais.


```{r, echo = FALSE}

totc <- labs %>% group_by(laboratory) %>% summarize(m = max(tested_all)) %>% .$m %>% sum
daily <- labs %>% group_by(day) %>% summarise(all = sum(tested_all)) %>% ungroup %>% mutate(capacity = 100*all/totc)

ggplot(aes(x = day, y = capacity) , data = daily) + geom_line() + geom_point()+labs(title = paste("Total capacity percentage:",max(labs$day)))
```

```{r}

dm <- labs %>% group_by(day) %>% summarise(untested = 100*sum(not_tested, na.rm = TRUE)/sum(tested_all, na.rm = TRUE))

ggplot(aes(x = day, y = untested) , data = dm) + geom_line() + geom_point()+labs(title = paste("Not tested percentage:",max(labs$day)))
```



# Epideminė kreivė


Epideminė kreivė paskelbta SAM. Pateiktas tik [grafikas](tests/pdfs/COVID-19 situacija Lietuvoje_siuntimui.jpg). Iš jo duomenys buvo išskaičiuoti darant lyginamąją grafiko analizę. Mažiausias stulpelis buvo laikomas vienas atvejis, buvo laikoma, kad dieną užfiksuotų atvejų skaičius yra tiek kiek atitinkamame stulpelyje telpa mažiausių stulpelių.

Juoda spalva atidėta kada susirgta, raudona kada buvo patvirtintas teigiamas testas.

```{r}
epc <- read.csv("exceptions/epidemic_curve_20200427.csv", stringsAsFactors = FALSE) %>% mutate(day = ymd(day))

tt1 <- tt %>% mutate(incidence = ag(confirmed))

ggplot(aes(x= day, y = incidence), data = epc) + geom_point()+geom_line() +geom_point(data=tt1, colour="red")+geom_line(data=tt1, colour="red") +labs(title = "Confirmed and actual cases")
```