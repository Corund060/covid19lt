---
title: "Covid-19 Lietuvos savivaldybėse"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(htmltools)
library(flexdashboard)
library(dplyr)
library(lubridate)
library(DT)
Sys.setlocale(locale="lt_LT")
```



```{r, echo = FALSE}
ii <- read.csv("../data/lt-covid19-individual.csv") %>% mutate(day = ymd(day))
last_day <- max(ii$day)

l14 <- ii %>% filter(day>=last_day-days(13)) %>% count(administrative_level_3) 

l17 <- ii %>% filter(day>=last_day-days(6)) %>% count(administrative_level_3) %>% rename(first = n)
l27 <- ii %>% filter(day>=last_day-days(13) & day<last_day-days(6)) %>% count(administrative_level_3) %>% rename(second = n)

fixNA <- function(x) {
    x[is.na(x)] <- 0
    x
}

wk <- l17 %>% full_join(l27, by = "administrative_level_3") %>%  mutate(first=fixNA(first), second = fixNA(second), Augimas = round(100*(first/second-1),2))

l14 <- l14 %>% left_join(wk %>% select(administrative_level_3, Augimas), by = "administrative_level_3")

rr <- read.csv("../raw_data/administrative_levels.csv")



dp <- l14 %>% right_join(rr, by = "administrative_level_3") %>% mutate(n = fixNA(n), Atvejai_100k = round(n/population*100000,2)) %>% arrange(administrative_level_3)
    
regs_n <- paste0(gsub("[.]","",gsub(" ", "_",dp$administrative_level_3)),".html")


links <- paste0("regions/", regs_n) 

links2 <- mapply(function(nm, hr) tags$a(href=hr, nm),  dp$administrative_level_3, links, SIMPLIFY = FALSE)

dp$administrative_level_3 <- sapply(links2,as.character)

colnames(dp) <- c("Savivaldybė", "Atvejai","Augimas","Populiacija","Atvejai_100k")
dp <- dp[,c(1,2,5,3,4)]

dp %>% datatable( 
         extensions = c('FixedColumns',"FixedHeader"),
         escape = FALSE,
          options = list(scrollX = TRUE, 
                         paging=FALSE,
                         fixedHeader=TRUE))

```



