---
title: "COVID-19 Lietuvoje"

site: distill::distill_website
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(dygraphs)
library(xts)
library(lubridate)
library(DT)
library(htmltools)
library(gridExtra)
```

```{r include=FALSE}
data <- Sys.time()
```
  - [Savivaldybių statistika](savivaldybes.html)    
  - [Europos šalių 14 dienų atvejai 100 tūkst. gyventojų](countries.html)
  - [Laboratorijų duomenys](stats.html)
  - [Efektyvusis R](Re.html)
  
Atnaujinta: `r format(data, usetz = TRUE)`. 

```{r, echo = FALSE}
aa <- read.csv("data/lt-covid19-aggregate.csv", stringsAsFactors = FALSE) %>% mutate(day = ymd(day))
last_day <- max(aa$day)
fixNA <- function(x) {
    x[is.na(x)] <- 0
    x
}

ltR <- dget("raw_data/effectiveR/ltR.R")
ag <- function(x)(c(x[1],diff(x)))
dt <- aa %>% mutate(incidence = ag(confirmed)) %>% select(day, confirmed, incidence) %>% mutate(day = ymd(day), w = ifelse(incidence == 0, 0, 1))
dtf <- dt
dt <- dt %>% filter(day >= "2020-03-11") %>% mutate(times = 1:n())

oo <- ltR$R %>% inner_join(dt %>% rename(t_end=times), by ="t_end") %>% select(day, R = `Mean(R)`, lwr = `Quantile.0.025(R)`,upr = `Quantile.0.975(R)`)
bb <- xts(oo %>% select(-day), order.by=ymd(oo$day))
dygraph(bb, main = "Efektyvus reprodukcinis skaičius R") %>% dySeries(c("lwr","R","upr"), label = "R") %>% dyRangeSelector()

```


```{r, echo = FALSE}
stt <- aa %>% select(day, confirmed, deaths, recovered) %>% pivot_longer(confirmed:recovered, "type")

xtt <- xts(aa %>% select(deaths, confirmed, recovered, -day), order.by =aa$day)

dygraph(xtt, main = paste("Suminiai atvejai:",max(aa$day))) %>%  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")) %>% dyRangeSelector()
```

```{r, echo = FALSE}

sdr <- aa %>% select(day, deaths) %>%  mutate(daily_deaths = ag(deaths))

xsdr1 <- xts(sdr$daily_deaths, order.by = sdr$day)
xsdr7 <- rollmean(xsdr1, 7, fill = NA, align = "right")
xsdr14 <- rollmean(xsdr1, 14, fill = NA, align = "right")

xsdr <- cbind(xsdr1, xsdr7, xsdr14)
colnames(xsdr) <- c("deaths", "deaths7", "deaths14")


dygraph(xsdr, main = paste("Mirtys per dieną ir slenkantys vidurkiai",max(aa$day))) %>%  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")) %>% dyRangeSelector()
```

```{r, echo = FALSE}
axtt <- xts(aa$incidence, order.by =aa$day)
colnames(axtt) <- "incidence"

axtt7 <- rollmean(axtt, 7, fill = NA, align = "right")
axtt14 <- rollmean(axtt, 14, fill = NA, align = "right")
colnames(axtt7) <- paste0(colnames(axtt7),"7")
colnames(axtt14) <- paste0(colnames(axtt14),"14")

a714 <- cbind(axtt, axtt7, axtt14)

dygraph(a714[, c("incidence", "incidence7","incidence14")], main = paste("Dieniniai atvejai ir slenkantys vidurkiai:",max(aa$day))) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(3,2,1)]) %>% dyRangeSelector
```

```{r, echo =FALSE}
labs <- read.csv("data/lt-covid19-laboratory-total.csv", stringsAsFactors = FALSE) %>% mutate(day = ymd(day))

lbt <- labs %>% group_by(day) %>% summarise(daily_tests = sum(tested_all, na.rm=TRUE), positive_all = sum(positive_all, na.rm = TRUE), ratio = round(100*positive_all/daily_tests,2))

ltt <- aa %>% mutate(daily_tests = ag(tested)) %>% select(day, daily_tests)

lct <- ltt %>% left_join(lbt %>% rename(laboratory_tests = daily_tests), by = "day") %>% 
    mutate(sam_daily_tests = daily_tests, 
           daily_tests = ifelse(is.na(laboratory_tests), sam_daily_tests, laboratory_tests))

tpd <- aa %>% select(day, confirmed) %>% left_join(lct, by = "day") %>% 
    mutate(incidence = ag(confirmed), normalized = incidence*100/daily_tests, 
           incidence14 = rollsum(incidence, k = 14, fill = NA, align = "right"),
           tests14 = rollsum(daily_tests, k = 14, fill = NA, align = "right"),
           normalized14 = incidence14*100/tests14,
           incidence7 = rollsum(incidence, k = 7, fill = NA, align = "right"),
           tests7 = rollsum(daily_tests, k = 7, fill = NA, align = "right"),
           normalized7 = incidence7*100/tests7
           
           )  
    
xtpd <- xts(tpd %>% select(normalized, normalized7, normalized14), order.by = tpd$day)
colnames(xtpd) <- c("Atvejų proc.", "AP7", "AP14")

dygraph(xtpd, main = paste("Atvejų skaičius tenkantis 100 testų", max(aa$day))) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(3,2,1)]) %>% dyRangeSelector 
```


```{r, echo = FALSE}
xtpr <- xts(lbt$ratio, order.by = lbt$day)
colnames(xtpr) <- "Test positivity rate"
dygraph(xtpr, main = paste("Teigiamų testų skaičius tenkantis 100 testų", max(aa$day))) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(1)]) %>% dyRangeSelector 
```

```{r, echo = FALSE}
ii <- read.csv("data/lt-covid19-individual.csv") %>% mutate(day = ymd(day))
p100k <- round(nrow(ii %>% filter(day>= last_day-days(13)))/2794329*100*1000,2)

ll <- labs %>% filter(day>= last_day - days(6))

pr <- round(tpd$normalized7[nrow(tpd)],2)

```


### Atvejų amžiaus pasiskirstymas per pastarąsias 14 dienų, `r last_day`

Lietuvoje 100k gyventojų per pastarąsias 14 dienų tenka **`r p100k`** atvejų. Testų pozityvumo norma ([test positivity rate](https://ec.europa.eu/info/live-work-travel-eu/health/coronavirus-response/travel-during-coronavirus-pandemic/common-approach-travel-measures-eu_en)) **`r pr`**.

```{r}
agr <- read.csv("raw_data/agegroups.csv")
as_all <- expand_grid(age = unique(agr$age1), sex = c("Vyras","Moteris")) %>% mutate(n1 = 0)

oo <- ii%>% filter(day >= last_day- days(13)) %>% inner_join(agr, by = "age") %>% select(-age) %>% rename(age=age1) %>% count(age, sex) %>% right_join(as_all, by = c("age", "sex")) %>% select(-n1) %>% mutate(n = fixNA(n)) %>% rename(Atvejai = n, Amžius = age) %>% pivot_wider(names_from = "sex", values_from = "Atvejai", values_fill = 0)

ld14 <- max(ii$day)-days(13)

cols<-RColorBrewer::brewer.pal(3, "Set1")

pm <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Moteris)) + geom_col(fill = cols[1]) + geom_text(aes(label = Atvejai), hjust = 1.1) + coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous(trans = "reverse", expand = expansion(mult=c(0.15, 0))) +  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), plot.margin = unit(c(0.02, 0.01, 0.02, 0.02),"npc")) + labs(title = "Moterys")

pv <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Vyras)) + geom_col(fill = cols[2]) + geom_text(aes(label = Atvejai), hjust = -0.5)+coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous( expand = expansion(mult=c(0, 0.18)))+theme(plot.margin = unit(c(0.02, 0.02, 0.02, -0.03),"npc"), plot.title = element_text(hjust = 1)) + labs(title = "Vyrai")

grid.arrange(pm,
    pv,
    ncol=2
)
```

### Istorinis mirčių pasiskirstymas pagal amžių, `r last_day`

```{r}
last_day <- max(ii$day)


oo <- ii%>% filter(status == "Mirė") %>% inner_join(agr, by = "age") %>% select(-age) %>% rename(age=age1) %>% count(age, sex) %>% right_join(as_all, by = c("age", "sex")) %>% select(-n1) %>% mutate(n = fixNA(n))


oo <- oo %>% rename(Atvejai = n, Amžius = age) %>% pivot_wider(names_from = "sex", values_from = "Atvejai", values_fill = 0)


pm <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Moteris)) + geom_col(fill = cols[1]) + geom_text(aes(label = Atvejai), hjust = 1.1) + coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous(trans = "reverse", expand = expansion(mult=c(0.1, 0))) +  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), plot.margin = unit(c(0.02, 0.01, 0.02, 0.02),"npc")) + labs(title = "Moterys")

pv <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Vyras)) + geom_col(fill = cols[2]) + geom_text(aes(label = Atvejai), hjust = -0.5)+coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous( expand = expansion(mult=c(0, 0.11)))+theme(plot.margin = unit(c(0.02, 0.02, 0.02, -0.03),"npc"), plot.title = element_text(hjust = 1)) + labs(title = "Vyrai")

grid.arrange(pm,
    pv,
    ncol=2
)

```



## Atvejų pasiskirstymas pagal amžių ir savivaldybes `r last_day` 

```{r}
agre <- read.csv("data/lt-covid19-age-region-incidence.csv", check.names =  FALSE) 

agre1 <- agre %>% filter(day == max(day)) %>% select(-day) 

regs_n <- paste0(gsub("[.]","",gsub(" ", "_",agre1$administrative_level_3)),".html")

links <- paste0("regions/", regs_n) 

links2 <- mapply(function(nm, hr) tags$a(href=hr, nm),  agre1$administrative_level_3, links, SIMPLIFY = FALSE)


agre2 <- agre1
agre2$administrative_level_3 <- sapply(links2,as.character)
agre2$administrative_level_3[nrow(agre2)] <- "Total"

agre2 <- agre2 %>% rename(Savivaldybė = administrative_level_3)
agre2 %>% datatable( 
         extensions = c('FixedColumns',"FixedHeader"),
          escape = FALSE,
          options = list(scrollX = TRUE, 
                         paging=FALSE,
                         fixedHeader=TRUE))
```

## Atvejų skaičiai savivaldybėse `r last_day`

Nuo liepos 1d.

```{r, echo=FALSE}

ad <- ii %>% count(day,administrative_level_3) %>% mutate(day = ymd(day))

ggplot(aes(x=day, y = n ),
       data = ad %>% filter(day >= "2020-07-01", administrative_level_3 %in% (agre1 %>% pull(administrative_level_3)))) +
           facet_wrap(~administrative_level_3, scales = "free_y") +geom_line()
```

## Atvejų skaičių skirtumai duomenų šaltiniuose

```{r}
rr <- read.csv("data/lt-covid19-regions.csv") %>% mutate(day = ymd(day))
rr1 <- rr %>% group_by(day) %>% summarise(regions = sum(confirmed))
ra <- read.csv("data/lt-covid19-agegroups.csv") %>% mutate(day = ymd(day))
ra1 <- ra %>% group_by(day) %>% summarise(age = sum(confirmed))

dd1 <- read.csv("data/lt-covid19-daily.csv") %>% mutate(day = ymd(day)) %>% select(day, sam = confirmed)

alls <- aa %>% select(day, datagov = confirmed) %>% left_join(dd1) %>% left_join(rr1) %>% left_join(ra1)

allsx <- xts(alls %>% select(-day), order.by=alls$day)

dygraph(diff(allsx)) %>%  dyOptions(colors = RColorBrewer::brewer.pal(4, "Set1")) %>% dyRangeSelector()
```

